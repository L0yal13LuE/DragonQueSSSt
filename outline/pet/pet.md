# Pet Farming System

## Overview

The pet farming system allows users to rent pets that will farm items over time. The system includes three main commands:
- `/pet rent` - Rent a pet for farming
- `/pet status` - Check pet's current status
- `/pet recall` - Recall pet and collect rewards

## Implementation Details

### Database Schema

#### user_pets Table

```sql
CREATE TABLE public.user_pets (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  user_id TEXT NOT NULL,
  pet_type TEXT NOT NULL,
  start_time TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  end_time TIMESTAMP WITH TIME ZONE NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  CONSTRAINT user_pets_pkey PRIMARY KEY (id),
  CONSTRAINT user_pets_user_id_fkey FOREIGN KEY (user_id) REFERENCES users(id)
) TABLESPACE pg_default;

CREATE INDEX idx_user_pets_user_id ON public.user_pets(user_id);
```

### Constants

- **PET_COST**: 10 Como (in-game currency)
- **MAX_FARMING_HOURS**: 72 hours
- **ITEM_CHANCE_PER_HOUR**: 10% chance to find an item each hour
- **PET_TYPES**: ["cat", "chicken", "bird"]
- **COMO_MATERIAL_ID**: 1 (Como currency material ID)

### Time Handling

All time operations use Bangkok time (GMT+7):

```javascript
const getBangkokTime = () => {
  const now = new Date();
  return new Date(now.getTime() + 7 * 60 * 60 * 1000);
};
```

### Currency Handling

The system uses Como (material_id = 1) as currency:

- Checks user's Como balance using `getUserItem`
- Deducts Como using `updateUserItem`
- Handles edge cases like insufficient balance

### Reward System

When recalling a pet:
1. Calculate hours passed since pet was rented
2. For each hour, 10% chance to find a random item (rarity 1-3)
3. Add found items to user's inventory using `insertUserItem`

### Command Structure

#### /pet rent
- Requires pet_type parameter (cat, chicken, or bird)
- Checks if user has enough Como
- Deducts currency and creates pet record

#### /pet status
- Shows pet's current status and remaining time
- Displays when pet will return

#### /pet recall
- Calculates rewards based on time passed
- Adds rewards to user's inventory
- Deactivates the pet

## Files Created

1. **deploy-pet-commands.js** - Command deployment script
2. **managers/petManager.js** - Main logic for pet operations
3. **user_pets_table.sql** - Database schema for user_pets table
4. **pet.md** - This documentation file

## Integration

The pet system integrates with existing systems:
- Uses existing material provider functions
- Follows project's database patterns
- Uses Supabase for database operations
- Implements proper error handling

## Deployment

To deploy the pet system:
1. Run the SQL script to create the user_pets table
2. Deploy the command using `node deploy-pet-commands.js`
3. Ensure materials table has items with rarity 1-3
